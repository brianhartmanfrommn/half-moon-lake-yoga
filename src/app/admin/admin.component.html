<div class="admin-container">

  <div class="admin-content">
    <!-- Schedule New Class Section -->
    <mat-card class="action-card mat-elevation-z2">
      <mat-card-header>
        <mat-card-title><strong>{{ isEditing ? 'Edit Class' : 'Schedule New Class' }}</strong></mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div class="form-row">
          <mat-form-field appearance="outline">
            <mat-label>Date</mat-label>
            <input matInput [matDatepicker]="picker" [(ngModel)]="newClassDate">
            <mat-datepicker-toggle matIconSuffix [for]="picker"></mat-datepicker-toggle>
            <mat-datepicker #picker></mat-datepicker>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Time</mat-label>
            <mat-select [(ngModel)]="newClassTime">
              @for (slot of timeSlots; track slot.value) {
                <mat-option [value]="slot.value">{{ slot.label }}</mat-option>
              }
            </mat-select>
          </mat-form-field>
          
          <mat-form-field appearance="outline" class="location-field">
            <mat-label>Location</mat-label>
            <input matInput placeholder="e.g. Studio A" [(ngModel)]="newClassLocation">
          </mat-form-field>
        </div>

        @if (isEditing) {
          <div class="attendees-manager">
            <h3 class="mat-h3">Manage Attendees</h3>
            <div class="add-attendee-row">
              <mat-form-field appearance="outline" class="full-width">
                <mat-label>Add Attendee Name</mat-label>
                <input matInput [(ngModel)]="newAttendeeName" (keyup.enter)="addAttendee()">
                <button mat-icon-button matSuffix (click)="addAttendee()">
                  <mat-icon>add</mat-icon>
                </button>
              </mat-form-field>
            </div>
            <mat-chip-set>
              @for (person of editAttendees; track $index) {
                <mat-chip [removable]="true" (removed)="removeAttendee($index)">
                  {{ person }}
                  <mat-icon matChipRemove>cancel</mat-icon>
                </mat-chip>
              }
            </mat-chip-set>
          </div>
        }

        @if (message) {
          <div class="message-box" [class.error]="messageType === 'error'" [class.success]="messageType === 'success'">
            {{ message }}
          </div>
        }
      </mat-card-content>
      <mat-card-actions align="end">
        @if (isEditing) {
          <button mat-button (click)="cancelEdit()" [disabled]="isProcessing">Cancel</button>
          <button mat-raised-button style="background-color: #ff5722; color: white;" (click)="updateClass()" [disabled]="isProcessing || !newClassDate || !newClassTime || !newClassLocation">
            <mat-icon>save</mat-icon> Update Class
          </button>
        } @else {
          <button mat-raised-button color="accent" (click)="addNewClass()" [disabled]="isProcessing || !newClassDate || !newClassTime || !newClassLocation">
            <mat-icon>add</mat-icon> Schedule Class
          </button>
        }
      </mat-card-actions>
    </mat-card>

    <!-- Class List Table -->
    <mat-card class="list-card mat-elevation-z2">
      <mat-card-header>
        <mat-card-title><strong>Manage Classes</strong></mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div class="table-container desktop-view">
          <table mat-table [dataSource]="dataSource" class="w-full">
          
            <!-- Date Column -->
            <ng-container matColumnDef="date">
              <th mat-header-cell *matHeaderCellDef> Date </th>
              <td mat-cell *matCellDef="let cls"> {{ formatDateTime(cls.date) }} </td>
            </ng-container>

            <!-- Location Column -->
            <ng-container matColumnDef="location">
              <th mat-header-cell *matHeaderCellDef> Location </th>
              <td mat-cell *matCellDef="let cls"> {{ cls.location }} </td>
            </ng-container>

            <!-- Attendees Column -->
            <ng-container matColumnDef="attendees">
              <th mat-header-cell *matHeaderCellDef> Attendees </th>
              <td mat-cell *matCellDef="let cls"> {{ cls.attendees.length }} </td>
            </ng-container>

            <!-- Status Column -->
            <ng-container matColumnDef="status">
              <th mat-header-cell *matHeaderCellDef> Status </th>
              <td mat-cell *matCellDef="let cls">
                <mat-chip [color]="cls.isCanceled ? 'warn' : 'primary'" selected>
                  {{ cls.isCanceled ? 'Canceled' : 'Active' }}
                </mat-chip>
              </td>
            </ng-container>

            <!-- Actions Column -->
            <ng-container matColumnDef="actions">
              <th mat-header-cell *matHeaderCellDef> Actions </th>
              <td mat-cell *matCellDef="let cls">
              <button mat-icon-button color="primary" (click)="startEdit(cls)" title="Edit Class">
                <mat-icon>edit</mat-icon>
              </button>
                <button mat-icon-button color="warn" (click)="toggleCancel(cls)" [title]="cls.isCanceled ? 'Re-activate' : 'Cancel Class'">
                  <mat-icon>{{ cls.isCanceled ? 'restore' : 'block' }}</mat-icon>
                </button>
                <button mat-icon-button color="warn" (click)="deleteClass(cls.id)" title="Delete Class">
                  <mat-icon>delete</mat-icon>
                </button>
              </td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
            <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
          </table>
          <mat-paginator [pageSizeOptions]="[10, 20, 50]" [pageSize]="10" showFirstLastButtons aria-label="Select page of classes">
          </mat-paginator>
        </div>

        <!-- Mobile Card View -->
        <div class="mobile-view">
          @for (cls of classes(); track cls.id) {
            <div class="mobile-class-card">
              <div class="card-header">
                <div class="date-info">
                  <span class="date">{{ formatDateTime(cls.date) }}</span>
                </div>
                <mat-chip [color]="cls.isCanceled ? 'warn' : 'primary'" selected class="status-chip">
                  {{ cls.isCanceled ? 'Canceled' : 'Active' }}
                </mat-chip>
              </div>
              
              <div class="card-details">
                <div class="detail-row">
                  <mat-icon>location_on</mat-icon>
                  <span>{{ cls.location }}</span>
                </div>
                <div class="detail-row">
                  <mat-icon>group</mat-icon>
                  <span>{{ cls.attendees.length }} Attendees</span>
                </div>
              </div>

              <div class="card-actions">
                <button mat-stroked-button color="primary" (click)="startEdit(cls)">
                  Edit
                </button>
                <button mat-stroked-button color="warn" (click)="toggleCancel(cls)">
                  {{ cls.isCanceled ? 'Re-activate' : 'Cancel' }}
                </button>
                <button mat-stroked-button color="warn" (click)="deleteClass(cls.id)">
                  Delete
                </button>
              </div>
            </div>
          }
        </div>
      </mat-card-content>
    </mat-card>
  </div>
</div>